<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OTT ç­¾å + çŸ­ç½‘å€ç”Ÿæˆå™¨</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    padding: 2em;
    max-width: 600px;
    margin: auto;
    background: #f9fafb;
  }
  h1 {
    text-align: center;
    margin-bottom: 1.5em;
  }
  label { display: block; margin-top: 1em; font-weight: bold; }
  input, button {
    width: 100%; padding: .6em; margin-top: .4em;
    border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box;
  }
  button {
    background: #0078ff; color: #fff; cursor: pointer;
    font-size: 1.1em; font-weight: bold; border: none;
  }
  button:hover { background: #0066dd; }
  pre {
    background: #f6f6f6; padding: 1em; border-radius: 8px;
    word-wrap: break-word; margin-top: 1em;
  }
  .copy-btn {
    margin-top: .5em;
    background: #00b894;
  }
  .copy-btn:hover {
    background: #009874;
  }
</style>
</head>
<body>
<h1>ğŸ” OTT é“¾æ¥ç­¾å + çŸ­ç½‘å€ç”Ÿæˆå™¨</h1>

<!-- éšè—æ•æ„Ÿé…ç½® -->
<input id="secret" type="hidden" value="mySuperSecretKey">
<input id="domain" type="hidden" value="https://powertech.ott-1f4.workers.dev/">

<label>ç”¨æˆ· UID</label>
<input id="uid" placeholder="ä¾‹å¦‚ user123">

<label>è¿‡æœŸæ—¥æœŸæ—¶é—´ (æœ¬åœ°æ—¶é—´)</label>
<input id="exp" type="datetime-local">

<button onclick="generate()">ç”Ÿæˆç­¾åé“¾æ¥</button>

<h3>âœ… ç­¾åé“¾æ¥ç»“æœ</h3>
<pre id="output">(ç”Ÿæˆç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ)</pre>
<button class="copy-btn" onclick="copyText('output')">å¤åˆ¶ç­¾åé“¾æ¥</button>

<button style="margin-top:1.5em;background:#ff9800" onclick="makeShort()">ç”ŸæˆçŸ­ç½‘å€</button>

<h3>ğŸ”— çŸ­ç½‘å€ç»“æœ</h3>
<pre id="shortOutput">(çŸ­ç½‘å€å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ)</pre>
<button class="copy-btn" onclick="copyText('shortOutput')">å¤åˆ¶çŸ­ç½‘å€</button>

<script>
async function generate() {
  const uid = document.getElementById("uid").value.trim();
  const secret = document.getElementById("secret").value.trim();
  const expStr = document.getElementById("exp").value;
  const domain = document.getElementById("domain").value.trim();

  if (!uid || !secret || !expStr || !domain) {
    alert("è¯·å¡«å†™æ‰€æœ‰å­—æ®µï¼");
    return;
  }

  const exp = new Date(expStr).getTime();
  const text = `${uid}:${exp}`;
  const sig = await hmacSHA256(text, secret);
  const url = `${domain}?uid=${encodeURIComponent(uid)}&exp=${exp}&sig=${sig}`;

  document.getElementById("output").textContent = url;
}

// ğŸ” ç”Ÿæˆç­¾å
async function hmacSHA256(text, secret) {
  const key = await crypto.subtle.importKey(
    "raw",
    new TextEncoder().encode(secret),
    { name: "HMAC", hash: "SHA-256" },
    false,
    ["sign"]
  );
  const signature = await crypto.subtle.sign("HMAC", key, new TextEncoder().encode(text));
  return Array.from(new Uint8Array(signature))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

// ğŸ“‹ å¤åˆ¶æ–‡æœ¬
function copyText(id) {
  const text = document.getElementById(id).textContent;
  navigator.clipboard.writeText(text)
    .then(() => alert("âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"))
    .catch(() => alert("âŒ å¤åˆ¶å¤±è´¥"));
}

// âœ‚ï¸ è°ƒç”¨ Cloudflare Worker ç”ŸæˆçŸ­ç½‘å€
async function makeShort() {
  const longURL = document.getElementById("output").textContent.trim();
  if (!longURL || longURL.startsWith("(")) {
    alert("è¯·å…ˆç”Ÿæˆç­¾åé“¾æ¥ï¼");
    return;
  }

  const workerURL = "https://short.links-a15.workers.dev/"; // ä½ çš„ Cloudflare Worker

  try {
    const res = await fetch(workerURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ longURL }),
    });
    const data = await res.json();

    if (data.shortURL) {
      document.getElementById("shortOutput").textContent = data.shortURL;
    } else if (data.secureShortURL) {
      document.getElementById("shortOutput").textContent = data.secureShortURL;
    } else if (data.shortLink) {
      document.getElementById("shortOutput").textContent = data.shortLink;
    } else {
      document.getElementById("shortOutput").textContent =
        "âŒ çŸ­ç½‘å€ç”Ÿæˆå¤±è´¥ï¼š" + (data.error || "Unknown error");
    }
  } catch (err) {
    document.getElementById("shortOutput").textContent = "âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š" + err.message;
  }
}
</script>
</body>
</html>
