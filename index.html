<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ” OTT ç­¾å + çŸ­ç½‘å€ç”Ÿæˆå™¨ (MY Time)</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    padding: 2em;
    max-width: 600px;
    margin: auto;
    background: #f9fbff;
  }
  h1 {
    text-align: center;
    background: linear-gradient(90deg,#0078ff,#00c6ff);
    -webkit-background-clip: text;
    color: transparent;
    font-weight: 900;
    text-shadow: 0 0 12px rgba(0,180,255,0.4);
  }
  label { display: block; margin-top: 1em; font-weight: bold; }
  input, button {
    width: 100%; padding: .8em; margin-top: .5em;
    border-radius: 8px; border: 1px solid #ccc;
    font-size: 1em;
  }
  button {
    background: linear-gradient(90deg,#0078ff,#00c6ff);
    color: #fff;
    font-size: 1.1em;
    cursor: pointer;
    transition: 0.25s;
    box-shadow: 0 0 12px rgba(0,200,255,0.4);
  }
  button:hover { background: linear-gradient(90deg,#005ccc,#00aaff); }
  pre {
    background: #f7f7f7;
    padding: 1em;
    border-radius: 8px;
    word-break: break-all;
  }
  .hidden { display: none; }
  .time-note { color: #0078ff; font-size: 0.9em; text-align:center; }

  /* ğŸŒˆ Toast æç¤ºæ ·å¼ */
  #toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(90deg,#0078ff,#00c6ff);
    color: white;
    padding: 12px 24px;
    border-radius: 24px;
    font-size: 1em;
    box-shadow: 0 0 12px rgba(0,180,255,0.6);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease, transform 0.4s ease;
  }
  #toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(-10px);
  }
</style>
</head>
<body>

<h1>ğŸ” OTT ç­¾å + çŸ­ç½‘å€ç”Ÿæˆå™¨</h1>
<p class="time-note">å½“å‰ä½¿ç”¨æ—¶åŒºï¼šé©¬æ¥è¥¿äºšæ—¶é—´ (GMT+8)</p>

<!-- âœ… éšè— Worker å’Œå¯†é’¥ -->
<input id="secret" value="mySuperSecretKey" class="hidden">
<input id="domain" value="https://powertech.ott-1f4.workers.dev/" class="hidden">

<label>ç”¨æˆ· UID</label>
<input id="uid" placeholder="ä¾‹å¦‚ user123">

<label>è¿‡æœŸæ—¥æœŸæ—¶é—´ (é©¬æ¥è¥¿äºšæ—¶é—´)</label>
<input id="exp" type="datetime-local">

<!-- å¿«æ·è¿‡æœŸæ—¶é—´æŒ‰é’® -->
<div style="margin-top: 1em; display: flex; gap: 0.5em;">
  <button type="button" onclick="setExpiryMonths(3)">3ä¸ªæœˆ</button>
  <button type="button" onclick="setExpiryMonths(12)">1å¹´</button>
  <button type="button" onclick="setExpiryMonths(1200)">æ°¸ä¹…</button>
</div>

<button style="margin-top:1.5em;" onclick="generateFull()">ğŸš€ ç”Ÿæˆç­¾åå¹¶åˆ›å»ºçŸ­ç½‘å€</button>

<h3>ğŸ“‹ ç­¾åé“¾æ¥</h3>
<pre id="output">(ç”Ÿæˆä¸­...)</pre>
<button id="copyLongBtn" class="hidden" onclick="copyToClipboard('output')">å¤åˆ¶ç­¾åé“¾æ¥</button>

<h3>ğŸ”— çŸ­ç½‘å€</h3>
<pre id="shortOutput">(ç”Ÿæˆä¸­...)</pre>
<button id="copyShortBtn" onclick="copyToClipboard('shortOutput')">å¤åˆ¶çŸ­ç½‘å€</button>

<!-- ğŸŒˆ Toast æç¤ºæ¡† -->
<div id="toast"></div>

<script>
// ğŸ•’ è·å–é©¬æ¥è¥¿äºšæ—¶é—´
function getMalaysiaNow() {
  const utcNow = new Date();
  return new Date(utcNow.getTime() + 8 * 60 * 60 * 1000);
}

// å¿«æ·è¿‡æœŸæ—¶é—´è®¾ç½®
function setExpiryMonths(months) {
  const now = getMalaysiaNow();
  if (months >= 1200) now.setFullYear(now.getFullYear() + 100);
  else now.setMonth(now.getMonth() + months);
  document.getElementById("exp").value = now.toISOString().slice(0,16);
}

// ğŸ” HMAC ç­¾å
async function hmacSHA256(text, secret) {
  const key = await crypto.subtle.importKey(
    "raw", new TextEncoder().encode(secret),
    { name: "HMAC", hash: "SHA-256" },
    false, ["sign"]
  );
  const sig = await crypto.subtle.sign("HMAC", key, new TextEncoder().encode(text));
  return Array.from(new Uint8Array(sig)).map(b => b.toString(16).padStart(2,"0")).join("");
}

// ğŸŒˆ æ˜¾ç¤ºæç¤º
function showToast(msg) {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 2500);
}

// ğŸš€ ç”Ÿæˆç­¾å + çŸ­ç½‘å€
async function generateFull() {
  const uid = document.getElementById("uid").value.trim();
  const secret = document.getElementById("secret").value.trim();
  const domain = document.getElementById("domain").value.trim();
  const expStr = document.getElementById("exp").value;

  if (!uid || !expStr) {
    showToast("âš ï¸ è¯·å¡«å†™ UID å’Œè¿‡æœŸæ—¶é—´ï¼");
    return;
  }

  const expMY = new Date(expStr);
  const exp = expMY.getTime() - 8 * 60 * 60 * 1000;
  const text = `${uid}:${exp}`;
  const sig = await hmacSHA256(text, secret);
  const longURL = `${domain}?uid=${encodeURIComponent(uid)}&exp=${exp}&sig=${sig}`;

  document.getElementById("output").textContent = longURL;
  document.getElementById("copyLongBtn").classList.remove("hidden");

  // è°ƒç”¨çŸ­ç½‘å€ç”Ÿæˆæ¥å£
  try {
    const res = await fetch("https://short.links-a15.workers.dev/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ longURL })
    });
    const data = await res.json();

    if (data.shortURL) {
      document.getElementById("shortOutput").textContent = data.shortURL;
      await navigator.clipboard.writeText(data.shortURL);
      showToast("âœ… çŸ­ç½‘å€å·²è‡ªåŠ¨å¤åˆ¶ï¼");
    } else {
      document.getElementById("shortOutput").textContent = "âŒ ç”Ÿæˆå¤±è´¥ï¼š" + (data.error || "æœªçŸ¥é”™è¯¯");
      showToast("âŒ ç”ŸæˆçŸ­ç½‘å€å¤±è´¥");
    }
  } catch (err) {
    document.getElementById("shortOutput").textContent = "âŒ ç½‘ç»œé”™è¯¯ï¼š" + err.message;
    showToast("âš ï¸ ç½‘ç»œè¿æ¥é”™è¯¯");
  }
}

// ğŸ“‹ æ‰‹åŠ¨å¤åˆ¶
function copyToClipboard(id) {
  const text = document.getElementById(id).textContent.trim();
  if (!text) return showToast("âš ï¸ æ²¡æœ‰å†…å®¹å¯å¤åˆ¶ï¼");
  navigator.clipboard.writeText(text).then(() => {
    showToast("âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
  }).catch(() => showToast("âŒ å¤åˆ¶å¤±è´¥"));
}
</script>
</body>
</html>
