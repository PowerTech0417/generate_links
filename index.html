<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OTT ç­¾åé“¾æ¥ç”Ÿæˆå™¨</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    padding: 2em;
    max-width: 600px;
    margin: auto;
  }
  label { display: block; margin-top: 1em; font-weight: bold; }
  input, button {
    width: 100%; padding: .5em; margin-top: .3em;
    border-radius: 6px; border: 1px solid #ccc;
  }
  button { background: #0078ff; color: #fff; cursor: pointer; }
  .output-box {
    position: relative;
    background: #f6f6f6;
    padding: 1em;
    border-radius: 8px;
    word-wrap: break-word;
    margin-top: 1em;
  }
  #copyBtn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #4caf50;
    border: none;
    color: #fff;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9em;
    display: none;
  }
</style>
</head>
<body>
<h1>ğŸ” OTT ç­¾åé“¾æ¥ç”Ÿæˆå™¨</h1>

<label>ç”¨æˆ· UID</label>
<input id="uid" placeholder="ä¾‹å¦‚ user123">

<label>è¿‡æœŸæ—¥æœŸæ—¶é—´ (æœ¬åœ°æ—¶é—´)</label>
<input id="exp" type="datetime-local">

<button onclick="generate()">ç”Ÿæˆç­¾åé“¾æ¥</button>

<h3>âœ… ç”Ÿæˆç»“æœ</h3>
<div class="output-box">
  <button id="copyBtn" onclick="copyLink()">å¤åˆ¶</button>
  <pre id="output">(ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ)</pre>
</div>

<script>
// âš™ï¸ å›ºå®šé…ç½®
const SIGN_SECRET = "mySuperSecretKey"; // è¯·æ›¿æ¢
const WORKER_DOMAIN = "https://powertech.ott-1f4.workers.dev/";

async function generate() {
  const uid = document.getElementById("uid").value.trim();
  const expStr = document.getElementById("exp").value;
  if (!uid || !expStr) {
    alert("è¯·å¡«å†™æ‰€æœ‰å­—æ®µï¼");
    return;
  }

  const exp = new Date(expStr).getTime();
  const text = `${uid}:${exp}`;
  const sig = await hmacSHA256(text, SIGN_SECRET);
  const url = `${WORKER_DOMAIN}?uid=${encodeURIComponent(uid)}&exp=${exp}&sig=${sig}`;

  const output = document.getElementById("output");
  output.textContent = url;
  document.getElementById("copyBtn").style.display = "inline-block";
}

async function hmacSHA256(text, secret) {
  const key = await crypto.subtle.importKey(
    "raw",
    new TextEncoder().encode(secret),
    { name: "HMAC", hash: "SHA-256" },
    false,
    ["sign"]
  );
  const signature = await crypto.subtle.sign("HMAC", key, new TextEncoder().encode(text));
  return Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, "0")).join("");
}

// âœ… å…¼å®¹æ‰‹æœºçš„å¤åˆ¶å®ç°
function copyLink() {
  const text = document.getElementById("output").textContent.trim();
  if (!text || text.startsWith("(ç»“æœ")) {
    alert("æ²¡æœ‰å¯å¤åˆ¶çš„é“¾æ¥ï¼");
    return;
  }

  // ä¼˜å…ˆä½¿ç”¨ Clipboard API
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(() => showCopied());
  } else {
    // å…¼å®¹æ—§ç‰ˆæµè§ˆå™¨
    const textarea = document.createElement("textarea");
    textarea.value = text;
    textarea.style.position = "fixed";
    textarea.style.opacity = "0";
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    try {
      document.execCommand("copy");
      showCopied();
    } catch (err) {
      alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚");
    }
    document.body.removeChild(textarea);
  }
}

function showCopied() {
  const btn = document.getElementById("copyBtn");
  btn.textContent = "âœ… å·²å¤åˆ¶";
  btn.style.background = "#2e7d32";
  setTimeout(() => {
    btn.textContent = "å¤åˆ¶";
    btn.style.background = "#4caf50";
  }, 1500);
}
</script>
</body>
</html>
