<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OTT ç­¾åé“¾æ¥ + çŸ­ç½‘å€ç”Ÿæˆå™¨</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    padding: 2em;
    max-width: 600px;
    margin: auto;
  }
  label { display: block; margin-top: 1em; font-weight: bold; }
  input, button {
    width: 100%; padding: .6em; margin-top: .3em;
    border-radius: 6px; border: 1px solid #ccc;
  }
  button {
    background: #0078ff; color: #fff; cursor: pointer;
    font-size: 1.1em; font-weight: 600;
  }
  button.copy { background: #555; }
  button.short { background: #28a745; margin-top: 10px; }
  button.copy-short { background: #444; margin-top: 6px; }
  pre {
    background: #f6f6f6; padding: 1em;
    border-radius: 8px; word-wrap: break-word;
  }
</style>
</head>
<body>
<h1>ğŸ” OTT ç­¾åé“¾æ¥ç”Ÿæˆå™¨</h1>

<!-- éšè—å¯†é’¥ä¸ Worker åŸŸå -->
<input id="secret" type="hidden" value="mySuperSecretKey">
<input id="domain" type="hidden" value="https://powertech.ott-1f4.workers.dev/">

<label>ç”¨æˆ· UID</label>
<input id="uid" placeholder="ä¾‹å¦‚ user123">

<label>è¿‡æœŸæ—¥æœŸæ—¶é—´ (æœ¬åœ°æ—¶é—´)</label>
<input id="exp" type="datetime-local">

<!-- ä¸»æŒ‰é’® -->
<button onclick="generate()">ğŸš€ ç”Ÿæˆç­¾åé“¾æ¥</button>

<h3>âœ… ç­¾åç»“æœ</h3>
<pre id="output">(ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ)</pre>
<button class="copy" onclick="copyLink()">ğŸ“‹ å¤åˆ¶ç­¾åé“¾æ¥</button>

<!-- çŸ­ç½‘å€ç”Ÿæˆ -->
<button class="short" onclick="makeShort()">âš¡ ç”ŸæˆçŸ­ç½‘å€</button>

<pre id="shortOutput">(çŸ­ç½‘å€å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ)</pre>
<button class="copy-short" onclick="copyShort()">ğŸ“‹ å¤åˆ¶çŸ­ç½‘å€</button>

<script>
async function generate() {
  const uid = document.getElementById("uid").value.trim();
  const secret = document.getElementById("secret").value.trim();
  const expStr = document.getElementById("exp").value;
  const domain = document.getElementById("domain").value.trim();

  if (!uid || !secret || !expStr || !domain) {
    alert("è¯·å¡«å†™æ‰€æœ‰å­—æ®µï¼");
    return;
  }

  const exp = new Date(expStr).getTime();
  const text = `${uid}:${exp}`;
  const sig = await hmacSHA256(text, secret);
  const url = `${domain}?uid=${encodeURIComponent(uid)}&exp=${exp}&sig=${sig}`;

  document.getElementById("output").textContent = url;
  document.getElementById("shortOutput").textContent = "(çŸ­ç½‘å€å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ)";
}

async function hmacSHA256(text, secret) {
  const key = await crypto.subtle.importKey(
    "raw",
    new TextEncoder().encode(secret),
    { name: "HMAC", hash: "SHA-256" },
    false,
    ["sign"]
  );
  const signature = await crypto.subtle.sign("HMAC", key, new TextEncoder().encode(text));
  return Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, "0")).join("");
}

// ğŸ“‹ å¤åˆ¶ç­¾åé“¾æ¥
async function copyLink() {
  const text = document.getElementById("output").textContent;
  if (!text.startsWith("http")) return alert("è¯·å…ˆç”Ÿæˆç­¾åé“¾æ¥ï¼");
  await navigator.clipboard.writeText(text);
  alert("âœ… ç­¾åé“¾æ¥å·²å¤åˆ¶ï¼");
}

// âš¡ ç”ŸæˆçŸ­ç½‘å€
async function makeShort() {
  const original = document.getElementById("output").textContent.trim();
  if (!original.startsWith("http")) {
    alert("è¯·å…ˆç”Ÿæˆç­¾åé“¾æ¥ï¼");
    return;
  }

  const idSuffix = Math.floor(1000 + Math.random() * 9000);
  const path = `id${idSuffix}`;
  const proxyWorker = "https://links-50m.pages.dev/"; // ä½ çš„ä»£ç† Worker

  try {
    const res = await fetch(`${proxyWorker}?url=${encodeURIComponent(original)}&path=${path}`);
    const data = await res.json();

    if (data && data.shortURL) {
      document.getElementById("shortOutput").textContent = data.shortURL;
    } else {
      document.getElementById("shortOutput").textContent = "âŒ çŸ­ç½‘å€ç”Ÿæˆå¤±è´¥";
    }
  } catch (err) {
    document.getElementById("shortOutput").textContent = "âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥";
  }
}

// ğŸ“‹ å¤åˆ¶çŸ­ç½‘å€
async function copyShort() {
  const text = document.getElementById("shortOutput").textContent;
  if (!text.startsWith("http")) return alert("è¯·å…ˆç”ŸæˆçŸ­ç½‘å€ï¼");
  await navigator.clipboard.writeText(text);
  alert("âœ… çŸ­ç½‘å€å·²å¤åˆ¶ï¼");
}
</script>
</body>
</html>
