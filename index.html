<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ” OTT ç­¾å + çŸ­ç½‘å€ç”Ÿæˆå™¨</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    padding: 2em;
    max-width: 600px;
    margin: auto;
    background: radial-gradient(circle at top, #0a1a3a, #000);
    color: #fff;
  }
  h1 {
    text-align: center;
    background: linear-gradient(90deg, #00b7ff, #0078ff);
    -webkit-background-clip: text;
    color: transparent;
    font-size: 1.8em;
    font-weight: bold;
    margin-bottom: 1em;
    text-shadow: 0 0 12px #0078ff;
  }
  label { display: block; margin-top: 1em; font-weight: bold; }
  input, button {
    width: 100%;
    padding: .8em;
    margin-top: .5em;
    border-radius: 10px;
    border: 1px solid #0078ff;
    font-size: 1em;
  }
  input {
    background: #0d1b2a;
    color: #fff;
  }
  button {
    background: linear-gradient(90deg, #0078ff, #00b7ff);
    color: #fff;
    font-size: 1.1em;
    cursor: pointer;
    transition: 0.25s;
    border: none;
    box-shadow: 0 0 12px #00aaff;
  }
  button:hover {
    transform: scale(1.03);
    box-shadow: 0 0 18px #00ccff;
  }
  pre {
    background: #0d1b2a;
    padding: 1em;
    border-radius: 10px;
    word-break: break-all;
    border: 1px solid #0078ff;
    margin-top: 0.5em;
  }
  .hidden { display: none; }

  /* æ—¶é—´å¿«æ·æŒ‰é’® */
  .time-btns {
    display: flex;
    justify-content: space-between;
    margin-top: 1em;
    gap: 10px;
  }
  .time-btns button {
    flex: 1;
    background: linear-gradient(90deg, #0078ff, #00b7ff);
    border: none;
    box-shadow: 0 0 10px #0078ff;
    transition: 0.25s;
  }
  .time-btns button:hover {
    background: linear-gradient(90deg, #00b7ff, #0078ff);
    transform: scale(1.05);
  }

  /* å¼¹çª— */
  .popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #0078ff, #00d4ff);
    color: white;
    padding: 20px 40px;
    border-radius: 12px;
    box-shadow: 0 0 25px #00bfff;
    font-size: 1.2em;
    text-align: center;
    display: none;
    animation: glow 1s ease-out;
  }
  @keyframes glow {
    from { opacity: 0; transform: translate(-50%, -60%) scale(0.9); }
    to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  }
</style>
</head>
<body>

<h1>ğŸ” OTT é“¾æ¥ç­¾å + çŸ­ç½‘å€ç”Ÿæˆå™¨</h1>

<!-- âœ… éšè—çš„ Worker å’Œå¯†é’¥ -->
<input id="secret" value="mySuperSecretKey" class="hidden">
<input id="domain" value="https://powertech.ott-1f4.workers.dev/" class="hidden">

<label>ç”¨æˆ· UID</label>
<input id="uid" placeholder="ä¾‹å¦‚ user123">

<label>è¿‡æœŸæ—¥æœŸæ—¶é—´ï¼ˆé©¬æ¥è¥¿äºšæ—¶é—´ï¼‰</label>
<input id="exp" type="datetime-local">

<!-- å¿«æ·æ—¶é—´é€‰æ‹©æŒ‰é’® -->
<div class="time-btns">
  <button type="button" onclick="setExpiryMonths(1)">ğŸ—“ï¸ 1ä¸ªæœˆ</button>
  <button type="button" onclick="setExpiryMonths(12)">ğŸ“† 1å¹´</button>
  <button type="button" onclick="setExpiryMonths(1200)">â™¾ï¸ æ°¸ä¹…</button>
</div>

<button onclick="generateFull()">ğŸš€ ç”Ÿæˆç­¾åå¹¶åˆ›å»ºçŸ­ç½‘å€</button>

<h3>ğŸ“‹ ç­¾åé“¾æ¥</h3>
<pre id="output">(ç”Ÿæˆä¸­...)</pre>

<h3>ğŸ”— çŸ­ç½‘å€</h3>
<pre id="shortOutput">(ç”Ÿæˆä¸­...)</pre>

<div id="popup" class="popup">âœ… å·²è‡ªåŠ¨å¤åˆ¶çŸ­ç½‘å€ï¼</div>

<script>
// === æ—¶é—´æŒ‰é’®é€»è¾‘ï¼ˆä»¥é©¬æ¥è¥¿äºšæ—¶é—´è®¡ç®—ï¼‰ ===
function setExpiryMonths(months) {
  const expInput = document.getElementById("exp");
  const now = new Date();
  // è®¾ç½®æ—¶åŒºåç§»ï¼ˆé©¬æ¥è¥¿äºšæ—¶é—´ +8ï¼‰
  const malaysiaNow = new Date(now.getTime() + 8 * 60 * 60 * 1000);
  malaysiaNow.setMonth(malaysiaNow.getMonth() + months);
  expInput.value = malaysiaNow.toISOString().slice(0, 16);
}

// === HMAC è®¡ç®— ===
async function hmacSHA256(text, secret) {
  const key = await crypto.subtle.importKey(
    "raw",
    new TextEncoder().encode(secret),
    { name: "HMAC", hash: "SHA-256" },
    false,
    ["sign"]
  );
  const sig = await crypto.subtle.sign("HMAC", key, new TextEncoder().encode(text));
  return Array.from(new Uint8Array(sig)).map(b => b.toString(16).padStart(2, "0")).join("");
}

// === ä¸»é€»è¾‘ ===
async function generateFull() {
  const uid = document.getElementById("uid").value.trim();
  const secret = document.getElementById("secret").value.trim();
  const domain = document.getElementById("domain").value.trim();
  const expStr = document.getElementById("exp").value;

  if (!uid || !expStr) {
    alert("è¯·å¡«å†™ UID å’Œè¿‡æœŸæ—¶é—´ï¼");
    return;
  }

  const exp = new Date(expStr).getTime();
  const text = `${uid}:${exp}`;
  const sig = await hmacSHA256(text, secret);
  const longURL = `${domain}?uid=${encodeURIComponent(uid)}&exp=${exp}&sig=${sig}`;

  document.getElementById("output").textContent = longURL;

  // è°ƒç”¨çŸ­ç½‘å€ API
  try {
    const res = await fetch("https://short.links-a15.workers.dev/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ longURL })
    });
    const data = await res.json();

    if (data.shortURL) {
      document.getElementById("shortOutput").textContent = data.shortURL;
      copyText(data.shortURL);
    } else {
      document.getElementById("shortOutput").textContent =
        "âŒ çŸ­ç½‘å€ç”Ÿæˆå¤±è´¥ï¼š" + (data.error || "æœªçŸ¥é”™è¯¯");
    }
  } catch (err) {
    document.getElementById("shortOutput").textContent =
      "âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š" + err.message;
  }
}

// === è‡ªåŠ¨å¤åˆ¶ + ç‚«é…·å¼¹çª— ===
function copyText(text) {
  navigator.clipboard.writeText(text).then(() => {
    const popup = document.getElementById("popup");
    popup.style.display = "block";
    setTimeout(() => { popup.style.display = "none"; }, 2000);
  });
}
</script>
</body>
</html>
