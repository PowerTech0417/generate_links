<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OTT ç­¾åçŸ­é“¾ç”Ÿæˆå™¨ï¼ˆéšæœºIDç‰ˆï¼‰</title>
<style>
  body { font-family: system-ui, sans-serif; padding: 2em; max-width: 600px; margin: auto; }
  h1 { text-align: center; }
  label { display: block; margin-top: 1em; font-weight: bold; }
  input, button {
    width: 100%; padding: .6em; margin-top: .3em;
    border-radius: 8px; border: 1px solid #ccc; font-size: 1em;
  }
  #generateBtn {
    background: #0078ff; color: #fff; cursor: pointer;
    font-size: 1.2em; font-weight: bold; margin-top: 1.5em;
    padding: 0.8em; transition: background 0.2s ease;
  }
  #generateBtn:hover { background: #005fcc; }
  pre {
    background: #f6f6f6; padding: 1em; border-radius: 8px;
    word-wrap: break-word; margin-top: 1em;
  }
  #copyBtn {
    display: none; margin-top: 1em; width: auto; padding: 10px 24px;
    border-radius: 6px; background: #4caf50; border: none; color: white;
    font-size: 1em; cursor: pointer; display: block; margin-left: auto; margin-right: auto;
  }
</style>
</head>
<body>
<h1>ğŸ” OTT ç­¾åçŸ­é“¾ç”Ÿæˆå™¨</h1>

<label>ç”¨æˆ· UID</label>
<input id="uid" placeholder="ä¾‹å¦‚ user123">

<label>è¿‡æœŸæ—¥æœŸæ—¶é—´ (æœ¬åœ°æ—¶é—´)</label>
<input id="exp" type="datetime-local">

<button id="generateBtn" onclick="generate()">ç”Ÿæˆç­¾åçŸ­é“¾æ¥</button>

<h3>âœ… ç”Ÿæˆç»“æœ</h3>
<pre id="output">(ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ)</pre>
<button id="copyBtn" onclick="copyLink()">å¤åˆ¶çŸ­ç½‘å€</button>

<script>
// å›ºå®šé…ç½®
const SIGN_SECRET = "mySuperSecretKey";
const WORKER_DOMAIN = "https://powertech.ott-1f4.workers.dev/";
const SHORTIO_API_KEY = "pk_1x1NMq5cuSHbYAPJ"; // âš ï¸ ä½ çš„ Short.io API Key
const SHORT_DOMAIN = "short.io"; // âš ï¸ æ›¿æ¢ä¸ºä½ ç»‘å®šçš„ Short.io åŸŸå
const PREFIX = "id"; // è‡ªå®šä¹‰è·¯å¾„å‰ç¼€

function random4Digits() {
  return Math.floor(1000 + Math.random() * 9000).toString(); // 1000-9999
}

async function generate() {
  const uid = document.getElementById("uid").value.trim();
  const expStr = document.getElementById("exp").value;
  if (!uid || !expStr) return alert("è¯·å¡«å†™æ‰€æœ‰å­—æ®µï¼");

  const exp = new Date(expStr).getTime();
  const text = `${uid}:${exp}`;
  const sig = await hmacSHA256(text, SIGN_SECRET);
  const longUrl = `${WORKER_DOMAIN}?uid=${encodeURIComponent(uid)}&exp=${exp}&sig=${sig}`;

  document.getElementById("output").textContent = "â³ æ­£åœ¨ç”ŸæˆçŸ­ç½‘å€...";

  const path = `${PREFIX}${random4Digits()}`; // ä¾‹å¦‚ id4829

  try {
    const shortUrl = await createShortUrl(longUrl, path);
    document.getElementById("output").textContent = shortUrl;
    document.getElementById("copyBtn").style.display = "block";
  } catch (err) {
    document.getElementById("output").textContent = "âŒ çŸ­ç½‘å€ç”Ÿæˆå¤±è´¥ï¼š" + err.message;
  }
}

async function createShortUrl(originalURL, path) {
  const res = await fetch("https://api.short.io/links", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "authorization": SHORTIO_API_KEY
    },
    body: JSON.stringify({
      domain: SHORT_DOMAIN,
      originalURL,
      path
    })
  });

  if (!res.ok) throw new Error("API å“åº”é”™è¯¯ " + res.status);
  const data = await res.json();
  return data.shortURL;
}

async function hmacSHA256(text, secret) {
  const key = await crypto.subtle.importKey(
    "raw", new TextEncoder().encode(secret),
    { name: "HMAC", hash: "SHA-256" },
    false, ["sign"]
  );
  const signature = await crypto.subtle.sign("HMAC", key, new TextEncoder().encode(text));
  return Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, "0")).join("");
}

function copyLink() {
  const text = document.getElementById("output").textContent.trim();
  if (!text.startsWith("http")) return alert("æ²¡æœ‰å¯å¤åˆ¶çš„é“¾æ¥ï¼");
  navigator.clipboard.writeText(text).then(() => showCopied());
}

function showCopied() {
  const btn = document.getElementById("copyBtn");
  btn.textContent = "âœ… å·²å¤åˆ¶";
  btn.style.background = "#2e7d32";
  setTimeout(() => {
    btn.textContent = "å¤åˆ¶çŸ­ç½‘å€";
    btn.style.background = "#4caf50";
  }, 1500);
}
</script>
</body>
</html>
